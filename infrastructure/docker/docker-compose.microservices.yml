version: '3.8'

services:
  request-management:
    build:
      context: ../../services/request-management
      dockerfile: Dockerfile
    container_name: request-management-service
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DYNAMODB_TABLE_NAME=${AWS_DYNAMODB_TABLE_NAME:-aam_requests}
      - AWS_SQS_QUEUE_URL=${AWS_SQS_QUEUE_URL}
      - AI_PROCESSING_SERVICE_URL=http://ai-processing:8002
      - DECISION_SIMULATION_SERVICE_URL=http://decision-simulation:8003
      - EXECUTION_SERVICE_URL=http://execution:8004
      - ADMIN_API_KEY=${ADMIN_API_KEY:-test-admin-key}
    depends_on:
      - ai-processing
      - decision-simulation
      - execution
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ai-processing:
    build:
      context: ../../services/ai-processing
      dockerfile: Dockerfile
    container_name: ai-processing-service
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - AWS_REGION=${AWS_REGION:-us-west-2}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  decision-simulation:
    build:
      context: ../../services/decision-simulation
      dockerfile: Dockerfile
    container_name: decision-simulation-service
    ports:
      - "8003:8003"
    environment:
      - PORT=8003
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - RAG_ENABLED=true
      - VECTOR_STORE_PATH=/app/vector_stores/chroma_db
      - VECTOR_STORE_COLLECTION=apartment_kb
      - EMBEDDING_MODEL=all-MiniLM-L6-v2
      - RAG_TOP_K=5
      - RAG_SIMILARITY_THRESHOLD=0.7
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - REQUEST_MANAGEMENT_SERVICE_URL=http://request-management:8001
      - ADMIN_API_KEY=${ADMIN_API_KEY:-test-admin-key}
    volumes:
      - chroma-data:/app/vector_stores/chroma_db
      - ../../services/decision-simulation/app/kb:/app/kb:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  execution:
    build:
      context: ../../services/execution
      dockerfile: Dockerfile
    container_name: execution-service
    ports:
      - "8004:8004"
    environment:
      - PORT=8004
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SQS_QUEUE_URL=${AWS_SQS_QUEUE_URL}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  chroma-data:
    driver: local

networks:
  default:
    name: synergy-microservices-network

